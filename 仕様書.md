# 非鉄金属（錫）LMEポジション損益シミュレーションMVP 仕様書

## 1. プロジェクト概要

### 1.1 目的
非鉄金属（錫）のLMEポジション損益シミュレーションMVPをStreamlitで開発する。限月別のポジション・価格変動から損益を分解し、戦略の有効性を可視化する。

### 1.2 技術スタック
- **Python**: 3.9+
- **Streamlit**: >=1.28.0（Webアプリケーションフレームワーク）
- **pandas**: >=2.0.0（データ処理）
- **plotly**: >=5.17.0（可視化）
- **openpyxl**: >=3.1.0（Excelファイル読み込み）

## 2. ファイル構成

```
project/
├── app.py              # メインアプリケーション
├── requirements.txt    # 依存パッケージ一覧
├── 仕様書.md          # 本仕様書
└── 数量価格.xlsx      # デフォルトデータファイル（オプション）
```

## 3. データ仕様

### 3.1 Excelファイル形式

アプリケーションは以下の形式のExcelファイルを読み込む：

#### 3.1.1 価格シート
- **シート名**: 「価格」（または「price」を含む名前）
- **構造**:
  - 第1列: Prompt（限月名: Cash、3M、M+4など）
  - 第2列以降: 日付列（例: 1月末、2月末）
- **例**:
  ```
  Prompt    1月末    2月末
  Cash      27,800   28,600
  3M        27,300   26,500
  M+4       27,050   26,400
  ```

#### 3.1.2 数量シート
- **シート名**: 「数量」（または「qty」「quantity」を含む名前）
- **構造**:
  - 第1列: Prompt（限月名: Cash、3M、M+4など）
  - 第2列以降: 日付列（例: 1月末、2月末）
- **例**:
  ```
  Prompt    1月末    2月末
  Cash      800      900
  3M        -500     -200
  M+4       -130     -250
  ```

### 3.2 データ読み込みロジック

1. **デフォルトファイル**: `数量価格.xlsx`が存在する場合、自動的に読み込む
2. **アップロードファイル**: サイドバーからExcelファイルをアップロード可能
3. **シート検出**: シート名に「価格」「数量」が含まれる場合、自動検出
4. **フォールバック**: シート名が不明な場合、最初の2つのシートを使用

## 4. 機能仕様

### 4.1 タブ構成

アプリケーションは3つのタブで構成される：

1. **📊 限月別P/L**: 各限月の損益計算と表示
2. **📈 Spread分析**: Cash-3M間のSpread分析
3. **🔄 戦略比較**: Hold戦略とActual戦略の比較

### 4.2 Tab1: 限月別P/L

#### 4.2.1 計算ロジック

**基本P/L計算式**:
```
価格変動 = 価格(2月末) - 価格(1月末)
Hold P/L = 数量(1月末) × 価格変動
Actual P/L = 数量(2月末) × 価格変動
```

#### 4.2.2 表示項目

| 項目 | 説明 |
|------|------|
| Prompt | 限月名（Cash、3M、M+4など） |
| 数量(1月末) | 開始時点のポジション数量 |
| 数量(2月末) | 終了時点のポジション数量 |
| 価格(1月末) | 開始時点の価格（USD） |
| 価格(2月末) | 終了時点の価格（USD） |
| 価格変動 | 価格の変化量（USD） |
| Hold P/L | Hold戦略の損益（USD） |
| Actual P/L | Actual戦略の損益（USD） |
| 合計 | 各項目の合計値 |

#### 4.2.3 可視化

- **限月別P/L比較棒グラフ**: Hold P/LとActual P/Lを並べて表示
- グラフタイプ: Plotly Bar Chart（グループ化）
- 単位: USD

### 4.3 Tab2: Spread分析

#### 4.3.1 計算ロジック

**Spread計算式**:
```
Spread(1月末) = 価格Cash(1月末) - 価格3M(1月末)
Spread(2月末) = 価格Cash(2月末) - 価格3M(2月末)
Spread変動 = Spread(2月末) - Spread(1月末)
```

**Spread Qty計算式**:
```
Spread Qty = min(|数量Cash|, |数量3M|)
※ Cashと3Mが逆方向のポジションの場合のみ
```

**Spread P/L計算式**:
```
Spread P/L(Hold) = Spread Qty(1月末) × Spread変動
Spread P/L(Actual) = Spread Qty(2月末) × Spread変動
```

#### 4.3.2 表示項目

| 項目 | 説明 |
|------|------|
| Spread(1月末) | 開始時点のSpread（USD） |
| Spread(2月末) | 終了時点のSpread（USD） |
| Spread変動 | Spreadの変化量（USD） |
| Spread Qty(1月末) | 開始時点のSpread数量 |
| Spread Qty(2月末) | 終了時点のSpread数量 |
| Spread P/L(Hold) | Hold戦略のSpread損益（USD） |
| Spread P/L(Actual) | Actual戦略のSpread損益（USD） |

#### 4.3.3 可視化

- **Spread推移グラフ**: 時系列でのSpread変化を表示
- グラフタイプ: Plotly Scatter（lines+markers）
- 単位: USD

### 4.4 Tab3: 戦略比較

#### 4.4.1 計算ロジック

**戦略効果計算式**:
```
Total Hold P/L = Σ(各限月のHold P/L)
Total Actual P/L = Σ(各限月のActual P/L)
Strategy Effect = Total Actual P/L - Total Hold P/L
```

#### 4.4.2 表示項目

| 戦略 | Total P/L | 説明 |
|------|-----------|------|
| Hold | XXX | 1月末ポジションを2月末まで保持した場合の損益 |
| Actual | XXX | 2月末の実際のポジションでの損益 |
| Strategy Effect | XXX | ポジション変更による効果（Actual - Hold） |

#### 4.4.3 可視化

**ウォーターフォールチャート**:
- Hold P/L（開始点）
- ポジション変更効果（増減）
- Actual P/L（終了点）
- グラフタイプ: Plotly Waterfall Chart
- 単位: USD

**限月別内訳テーブル**:
- 各限月のHold P/L、Actual P/L、差分を表示

## 5. UI/UX仕様

### 5.1 レイアウト

- **ページ設定**: Wide layout（全幅表示）
- **タイトル**: 「非鉄金属ポジション損益シミュレーター（MVP）」
- **サイドバー**: データ入力エリア

### 5.2 サイドバー機能

1. **ファイルアップローダー**
   - Excelファイル（.xlsx）をアップロード可能
   - ドラッグ&ドロップ対応

2. **データ読み込み状態表示**
   - 成功: 緑色の成功メッセージ
   - エラー: 赤色のエラーメッセージ
   - 情報: 青色の情報メッセージ

3. **デフォルトファイル使用表示**
   - `数量価格.xlsx`が存在する場合、自動使用を通知

### 5.3 メインエリア

1. **分析期間表示**
   - 使用している日付列を表示（例: 「分析期間: 1月末 → 2月末」）

2. **データ構造確認**（展開可能）
   - 価格データのプレビュー
   - 数量データのプレビュー
   - インデックスと列名の一覧

3. **タブナビゲーション**
   - 3つのタブで機能を切り替え

### 5.4 数値フォーマット

- **表示形式**: カンマ区切り、小数点以下なし
- **例**: `27,800`, `-500`, `640,000`
- **単位**: USD（明記）

## 6. エラーハンドリング

### 6.1 データ読み込みエラー

| エラーケース | 処理方法 |
|------------|---------|
| ファイル未アップロード | 案内メッセージを表示 |
| シート名不一致 | エラーメッセージ表示、シート一覧を表示 |
| データが空 | エラーメッセージ表示 |
| 共通列が2つ未満 | エラーメッセージ表示、列名一覧を表示 |

### 6.2 データ検証

1. **数量合計チェック**
   - 数量合計が0でない場合、警告メッセージを表示
   - 計算は継続

2. **データ型チェック**
   - 文字列を数値に変換可能かチェック
   - 変換不可の場合は0として処理

3. **欠損値処理**
   - NaN値は0として処理
   - 計算エラーを防止

### 6.3 計算エラー

- **KeyError**: インデックスや列名が見つからない場合、0を返す
- **ValueError**: 型変換エラーの場合、0を返す
- **TypeError**: 型エラーの場合、0を返す

## 7. 実装詳細

### 7.1 主要関数

#### 7.1.1 `safe_get_value(df, idx, col, default=0)`
安全にデータを取得して数値に変換する関数

**パラメータ**:
- `df`: pandas DataFrame
- `idx`: 行インデックス
- `col`: 列名
- `default`: デフォルト値（デフォルト: 0）

**戻り値**: float型の数値

**処理内容**:
1. 列が存在するかチェック
2. 値がNaNかチェック
3. 文字列の場合は数値に変換（カンマ除去）
4. エラー時はデフォルト値を返す

#### 7.1.2 `is_numeric_column(df, col)`
列が数値データを含むかチェックする関数

**パラメータ**:
- `df`: pandas DataFrame
- `col`: 列名

**戻り値**: bool（数値列の場合True）

**処理内容**:
1. 列のサンプルデータを取得
2. 各値を数値に変換可能かチェック
3. 文字列の場合はカンマ除去後に変換を試みる

### 7.2 データ処理フロー

```
1. Excelファイル読み込み
   ↓
2. シート検出（価格・数量）
   ↓
3. データフレーム作成（index_col=0）
   ↓
4. 列名の検証とフィルタリング
   ↓
5. 共通の数値列を特定
   ↓
6. 日付列の選択（最初の2つ）
   ↓
7. 各限月のP/L計算
   ↓
8. Spread計算（Cash-3M）
   ↓
9. 戦略比較計算
   ↓
10. 可視化と表示
```

### 7.3 データ構造

#### 7.3.1 価格データフレーム
```
Index: Prompt (Cash, 3M, M+4, ...)
Columns: 日付列 (1月末, 2月末, ...)
Values: 価格（数値）
```

#### 7.3.2 数量データフレーム
```
Index: Prompt (Cash, 3M, M+4, ...)
Columns: 日付列 (1月末, 2月末, ...)
Values: 数量（数値、正負あり）
```

## 8. 計算式詳細

### 8.1 基本P/L計算

**符号の扱い**:
- ロングポジション（正の数量）: 価格上昇で利益
- ショートポジション（負の数量）: 価格下落で利益

**計算例**:
```
Cash: 数量=800, 価格変動=+800
  → Hold P/L = 800 × 800 = +640,000

3M: 数量=-500, 価格変動=-800
  → Hold P/L = -500 × (-800) = +400,000
```

### 8.2 Spread計算

**Spread Qtyの決定**:
- Cashと3Mが逆方向（符号が異なる）の場合のみ計算
- 絶対値の小さい方をSpread Qtyとする

**計算例**:
```
Cash: 数量=800（ロング）
3M: 数量=-500（ショート）
Spread Qty = min(800, 500) = 500

Spread変動 = +1,600
Spread P/L = 500 × 1,600 = +800,000
```

## 9. 可視化仕様

### 9.1 限月別P/L比較グラフ

- **タイプ**: Grouped Bar Chart
- **X軸**: 限月（Prompt）
- **Y軸**: P/L（USD）
- **系列**: Hold P/L（青）、Actual P/L（赤）
- **高さ**: 500px

### 9.2 Spread推移グラフ

- **タイプ**: Line Chart with Markers
- **X軸**: 日付（1月末、2月末）
- **Y軸**: Spread（USD）
- **線の太さ**: 3px
- **マーカーサイズ**: 10px
- **高さ**: 400px

### 9.3 ウォーターフォールチャート

- **タイプ**: Waterfall Chart
- **項目**: Hold P/L、ポジション変更効果、Actual P/L
- **色設定**:
  - 増加: 緑
  - 減少: 赤
  - 合計: 青
- **テキスト表示**: 各項目の値を表示
- **高さ**: 500px

## 10. 開発・運用

### 10.1 開発環境セットアップ

```bash
# 仮想環境作成
python -m venv venv

# 仮想環境有効化（Windows）
venv\Scripts\activate

# 仮想環境有効化（Mac/Linux）
source venv/bin/activate

# パッケージインストール
pip install -r requirements.txt
```

### 10.2 アプリケーション起動

```bash
streamlit run app.py
```

### 10.3 デフォルトデータファイル

- ファイル名: `数量価格.xlsx`
- 配置場所: プロジェクトルートディレクトリ
- シート名: 「価格」「数量」

## 11. 制約事項・注意点

### 11.1 データ形式制約

1. **必須シート**: 価格シートと数量シートが必須
2. **共通列**: 価格と数量で共通の日付列が2つ以上必要
3. **インデックス**: 第1列がPrompt（限月名）として使用される
4. **数値データ**: 日付列は数値データである必要がある

### 11.2 計算上の注意

1. **数量合計**: 理論上は0であるべきだが、0でない場合も計算は継続
2. **Spread計算**: Cash-3Mのペアが存在しない場合、警告を表示
3. **日付列の選択**: 最初の2つの共通列を使用（手動選択不可）

### 11.3 パフォーマンス

- 小規模データ（100行以下）を想定
- リアルタイム計算（ファイル読み込み時のみ）

## 12. 今後の拡張可能性

### 12.1 機能拡張候補

1. **複数期間対応**: 3期間以上の比較
2. **日付選択機能**: ユーザーが日付列を選択可能
3. **CSV対応**: Excel以外の形式対応
4. **データエクスポート**: 計算結果をExcel/CSVで出力
5. **履歴管理**: 過去の分析結果を保存・比較

### 12.2 UI改善候補

1. **ダークモード対応**
2. **レスポンシブデザイン**
3. **多言語対応**
4. **カスタマイズ可能なグラフ設定**

## 13. バージョン情報

- **バージョン**: 1.0.0 (MVP)
- **最終更新**: 2024年
- **開発環境**: Python 3.9+, Streamlit 1.28.0+

## 14. 参考資料

- Streamlit公式ドキュメント: https://docs.streamlit.io/
- Plotly公式ドキュメント: https://plotly.com/python/
- pandas公式ドキュメント: https://pandas.pydata.org/

---

**本仕様書は、実装内容に基づいて作成されています。**

